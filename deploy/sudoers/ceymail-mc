# CeyMail Mission Control — privileges for dashboard
# Install: cp deploy/sudoers/ceymail-mc /etc/sudoers.d/ceymail-mc && chmod 0440 /etc/sudoers.d/ceymail-mc

# Preserve DEBIAN_FRONTEND through sudo so apt-get sees noninteractive mode
# (env_reset strips it by default, causing debconf prompts to hang)
# Scoped to ceymail-mc only to avoid affecting other sudo users
Defaults:ceymail-mc env_keep += "DEBIAN_FRONTEND"

# ── Runtime: service management (start/stop/restart whitelisted mail services) ──
# ceymail-dashboard restart: required for the setup wizard to reload SESSION_SECRET
# into the Edge middleware (which can only read env vars, not config files).

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/systemctl restart ceymail-dashboard, \
                                /usr/bin/systemctl start postfix, \
                                /usr/bin/systemctl stop postfix, \
                                /usr/bin/systemctl restart postfix, \
                                /usr/bin/systemctl start dovecot, \
                                /usr/bin/systemctl stop dovecot, \
                                /usr/bin/systemctl restart dovecot, \
                                /usr/bin/systemctl start mariadb, \
                                /usr/bin/systemctl stop mariadb, \
                                /usr/bin/systemctl restart mariadb, \
                                /usr/bin/systemctl start opendkim, \
                                /usr/bin/systemctl stop opendkim, \
                                /usr/bin/systemctl restart opendkim, \
                                /usr/bin/systemctl start spamassassin, \
                                /usr/bin/systemctl stop spamassassin, \
                                /usr/bin/systemctl restart spamassassin, \
                                /usr/bin/systemctl start spamd, \
                                /usr/bin/systemctl stop spamd, \
                                /usr/bin/systemctl restart spamd, \
                                /usr/bin/systemctl start apache2, \
                                /usr/bin/systemctl stop apache2, \
                                /usr/bin/systemctl restart apache2, \
                                /usr/bin/systemctl start nginx, \
                                /usr/bin/systemctl stop nginx, \
                                /usr/bin/systemctl restart nginx, \
                                /usr/bin/systemctl start unbound, \
                                /usr/bin/systemctl stop unbound, \
                                /usr/bin/systemctl restart unbound, \
                                /usr/bin/systemctl start rsyslog, \
                                /usr/bin/systemctl stop rsyslog, \
                                /usr/bin/systemctl restart rsyslog, \
                                /usr/bin/systemctl start php8.1-fpm, \
                                /usr/bin/systemctl start php8.2-fpm, \
                                /usr/bin/systemctl start php8.3-fpm, \
                                /usr/bin/systemctl start php8.4-fpm, \
                                /usr/bin/systemctl stop php8.1-fpm, \
                                /usr/bin/systemctl stop php8.2-fpm, \
                                /usr/bin/systemctl stop php8.3-fpm, \
                                /usr/bin/systemctl stop php8.4-fpm, \
                                /usr/bin/systemctl restart php8.1-fpm, \
                                /usr/bin/systemctl restart php8.2-fpm, \
                                /usr/bin/systemctl restart php8.3-fpm, \
                                /usr/bin/systemctl restart php8.4-fpm, \
                                /usr/bin/systemctl reload nginx, \
                                /usr/bin/systemctl reload apache2

# ── Runtime: postfix mail queue management ──
# postsuper -d ALL: clear entire queue. postsuper -d *: delete individual messages by queue ID.
# Wildcard is necessary because sudoers cannot restrict to hex patterns.
# Primary input validation happens in the API layer (api/queue/route.ts).
# ceymail-mc has nologin shell, limiting interactive exploitation.

ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/postqueue -f, \
                                /usr/sbin/postsuper -d ALL, \
                                /usr/sbin/postsuper -d *

# ── Install wizard: package installation (enumerated — matches ALLOWED_PACKAGES in API) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/apt-get update
ceymail-mc ALL=(root) NOPASSWD: /usr/bin/apt-get install -y --no-install-recommends apache2, \
                                /usr/bin/apt-get install -y --no-install-recommends certbot, \
                                /usr/bin/apt-get install -y --no-install-recommends python3-certbot-apache, \
                                /usr/bin/apt-get install -y --no-install-recommends python3-certbot-nginx, \
                                /usr/bin/apt-get install -y --no-install-recommends mariadb-server, \
                                /usr/bin/apt-get install -y --no-install-recommends postfix, \
                                /usr/bin/apt-get install -y --no-install-recommends postfix-mysql, \
                                /usr/bin/apt-get install -y --no-install-recommends dovecot-core, \
                                /usr/bin/apt-get install -y --no-install-recommends dovecot-imapd, \
                                /usr/bin/apt-get install -y --no-install-recommends dovecot-lmtpd, \
                                /usr/bin/apt-get install -y --no-install-recommends dovecot-mysql, \
                                /usr/bin/apt-get install -y --no-install-recommends opendkim, \
                                /usr/bin/apt-get install -y --no-install-recommends opendkim-tools, \
                                /usr/bin/apt-get install -y --no-install-recommends spamassassin, \
                                /usr/bin/apt-get install -y --no-install-recommends spamd, \
                                /usr/bin/apt-get install -y --no-install-recommends unbound, \
                                /usr/bin/apt-get install -y --no-install-recommends rsyslog, \
                                /usr/bin/apt-get install -y --no-install-recommends roundcube, \
                                /usr/bin/apt-get install -y --no-install-recommends roundcube-mysql, \
                                /usr/bin/apt-get install -y --no-install-recommends roundcube-plugins, \
                                /usr/bin/apt-get install -y --no-install-recommends php-fpm, \
                                /usr/bin/apt-get install -y --no-install-recommends php-mysql, \
                                /usr/bin/apt-get install -y --no-install-recommends php-gd, \
                                /usr/bin/apt-get install -y --no-install-recommends php-imap, \
                                /usr/bin/apt-get install -y --no-install-recommends php-curl, \
                                /usr/bin/apt-get install -y --no-install-recommends php-xml, \
                                /usr/bin/apt-get install -y --no-install-recommends php-mbstring, \
                                /usr/bin/apt-get install -y --no-install-recommends php-intl, \
                                /usr/bin/apt-get install -y --no-install-recommends php-zip

# ── Install wizard: enable/disable services (enumerated, no wildcards) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/systemctl enable postfix, \
                                /usr/bin/systemctl enable dovecot, \
                                /usr/bin/systemctl enable mariadb, \
                                /usr/bin/systemctl enable opendkim, \
                                /usr/bin/systemctl enable spamassassin, \
                                /usr/bin/systemctl enable spamd, \
                                /usr/bin/systemctl enable apache2, \
                                /usr/bin/systemctl enable nginx, \
                                /usr/bin/systemctl enable unbound, \
                                /usr/bin/systemctl enable rsyslog, \
                                /usr/bin/systemctl enable php8.1-fpm, \
                                /usr/bin/systemctl enable php8.2-fpm, \
                                /usr/bin/systemctl enable php8.3-fpm, \
                                /usr/bin/systemctl enable php8.4-fpm, \
                                /usr/bin/systemctl disable postfix, \
                                /usr/bin/systemctl disable dovecot, \
                                /usr/bin/systemctl disable opendkim, \
                                /usr/bin/systemctl disable spamassassin, \
                                /usr/bin/systemctl disable spamd, \
                                /usr/bin/systemctl disable apache2, \
                                /usr/bin/systemctl disable nginx, \
                                /usr/bin/systemctl disable unbound, \
                                /usr/bin/systemctl disable rsyslog, \
                                /usr/bin/systemctl disable php8.1-fpm, \
                                /usr/bin/systemctl disable php8.2-fpm, \
                                /usr/bin/systemctl disable php8.3-fpm, \
                                /usr/bin/systemctl disable php8.4-fpm

# ── Install wizard: user/group creation (restricted to vmail only) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/id vmail
ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/useradd -r -u 5000 -g mail -d /var/mail/vhosts -s /usr/sbin/nologin vmail
ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/useradd -r -u 5000 -g vmail -d /var/mail/vhosts -s /usr/sbin/nologin vmail
ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/groupadd -g 5000 vmail

# ── Install wizard: directory creation (restricted to mail-service paths) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/mkdir -p /var/mail/vhosts, \
                                /usr/bin/mkdir -p /etc/opendkim, \
                                /usr/bin/mkdir -p /etc/opendkim/keys, \
                                /usr/bin/mkdir -p /etc/opendkim/keys/*, \
                                /usr/bin/mkdir -p /etc/postfix, \
                                /usr/bin/mkdir -p /etc/dovecot, \
                                /usr/bin/mkdir -p /etc/spamassassin, \
                                /usr/bin/mkdir -p /var/spool/postfix/opendkim

# ── Install wizard: file ownership (restricted to mail-service paths) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/chown -R vmail\:vmail /var/mail/vhosts, \
                                /usr/bin/chown -R root\:postfix /etc/postfix, \
                                /usr/bin/chown -R root\:dovecot /etc/dovecot, \
                                /usr/bin/chown -R opendkim\:opendkim /etc/opendkim/keys, \
                                /usr/bin/chown -R opendkim\:opendkim /etc/opendkim/keys/*, \
                                /usr/bin/chown opendkim\:postfix /var/spool/postfix/opendkim, \
                                /usr/bin/chown -R root\:root /etc/spamassassin, \
                                /usr/bin/chown syslog\:adm /var/log/mail.log

# ── Install wizard: file permissions (restricted modes on specific paths) ──
# Multiple modes per glob is intentional: different files in the same directory
# need different permissions (e.g. postfix/main.cf=644, postfix/mysql-*.cf=640).
# The API layer determines which mode to apply to each file.

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/chmod 644 /etc/opendkim.conf, \
                                /usr/bin/chmod 755 /var/mail/vhosts, \
                                /usr/bin/chmod 755 /etc/postfix, \
                                /usr/bin/chmod 640 /etc/postfix/*, \
                                /usr/bin/chmod 755 /etc/dovecot, \
                                /usr/bin/chmod 600 /etc/dovecot/*, \
                                /usr/bin/chmod 750 /etc/opendkim/keys, \
                                /usr/bin/chmod 750 /etc/opendkim/keys/*, \
                                /usr/bin/chmod 640 /etc/opendkim/keys/*/*, \
                                /usr/bin/chmod 644 /etc/spamassassin/*, \
                                /usr/bin/chmod 640 /var/log/mail.log, \
                                /usr/bin/chmod 644 /etc/postfix/*, \
                                /usr/bin/chmod 644 /etc/dovecot/*, \
                                /usr/bin/chmod 640 /etc/dovecot/*, \
                                /usr/bin/chmod 644 /etc/opendkim/*, \
                                /usr/bin/chmod 750 /var/spool/postfix/opendkim

# ── DKIM group isolation (remove postfix from opendkim group — TCP milter eliminates need) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/gpasswd -d postfix opendkim

# ── DKIM key management (opendkim-genkey, key file removal) ──
# Wildcard is necessary for variable -b bits -d domain -D keydir -s selector flags.
# API layer (api/dkim/route.ts) validates domain/selector before calling sudo.
# Output files are restricted to /etc/opendkim/keys/ by subsequent chown/chmod rules.

ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/opendkim-genkey *
ceymail-mc ALL=(root) NOPASSWD: /usr/bin/rm /etc/opendkim/keys/*/*, \
                                /usr/bin/rmdir /etc/opendkim/keys/*

# ── DKIM key reading (keys owned opendkim:opendkim, dashboard reads via sudo) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/test -f /etc/opendkim/keys/*/*, \
                                /usr/bin/test -d /etc/opendkim/keys/*, \
                                /usr/bin/cat /etc/opendkim/keys/*/*, \
                                /usr/bin/ls /etc/opendkim/keys/*, \
                                /usr/bin/stat -c %Y /etc/opendkim/keys/*/*, \
                                /usr/bin/openssl rsa -in /etc/opendkim/keys/*/* -pubout -outform PEM, \
                                /usr/bin/openssl rsa -in /etc/opendkim/keys/*/* -text -noout

# ── Install wizard: specific file creation ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/touch /var/log/mail.log

# ── Install wizard: config file writing (enumerated paths — matches configs generated by API) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/tee /etc/postfix/main.cf, \
                                /usr/bin/tee /etc/postfix/master.cf, \
                                /usr/bin/tee /etc/postfix/mysql-virtual-mailbox-domains.cf, \
                                /usr/bin/tee /etc/postfix/mysql-virtual-mailbox-maps.cf, \
                                /usr/bin/tee /etc/postfix/mysql-virtual-alias-maps.cf, \
                                /usr/bin/tee /etc/postfix/dh2048.pem, \
                                /usr/bin/tee /etc/dovecot/dovecot.conf, \
                                /usr/bin/tee /etc/dovecot/dovecot-sql.conf.ext, \
                                /usr/bin/tee /etc/opendkim.conf, \
                                /usr/bin/tee /etc/opendkim/key.table, \
                                /usr/bin/tee /etc/opendkim/signing.table, \
                                /usr/bin/tee /etc/opendkim/trusted.hosts, \
                                /usr/bin/tee /etc/spamassassin/local.cf, \
                                /usr/bin/tee /etc/roundcube/config.inc.php, \
                                /usr/bin/tee /etc/nginx/snippets/roundcube-webmail.conf, \
                                /usr/bin/tee /etc/nginx/sites-available/roundcube-webmail

# ── Install wizard: SSL certificates ──
# Note: certbot certonly with * wildcard allows arbitrary flags including --deploy-hook.
# Primary defense is the API layer (ssl/route.ts) which constructs safe args with validated input.
# If ceymail-mc shell is compromised, this is exploitable. For stricter control, use a wrapper script.

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/certbot certonly *

# ── Webmail (Roundcube) setup ──
# Disable use_pty for the wrapper so stdin piping works (setup-user reads password from stdin)

Defaults!/usr/local/bin/ceymail-roundcube-db !use_pty

ceymail-mc ALL=(root) NOPASSWD: /usr/local/bin/ceymail-roundcube-db create-db, \
                                /usr/local/bin/ceymail-roundcube-db setup-user, \
                                /usr/local/bin/ceymail-roundcube-db import-schema, \
                                /usr/sbin/nginx -t, \
                                /usr/local/bin/ceymail-nginx-webmail add-include *, \
                                /usr/local/bin/ceymail-nginx-webmail remove-include, \
                                /usr/local/bin/ceymail-nginx-webmail cleanup-legacy, \
                                /usr/local/bin/ceymail-apache2-webmail add-include *, \
                                /usr/local/bin/ceymail-apache2-webmail remove-include, \
                                /usr/local/bin/ceymail-apache2-webmail cleanup-legacy, \
                                /usr/bin/rm -f /etc/nginx/snippets/roundcube-webmail.conf, \
                                /usr/bin/ln -sf /etc/nginx/sites-available/roundcube-webmail /etc/nginx/sites-enabled/roundcube-webmail, \
                                /usr/bin/rm -f /etc/nginx/sites-enabled/roundcube-webmail, \
                                /usr/bin/rm -f /etc/nginx/sites-available/roundcube-webmail, \
                                /usr/bin/chmod 640 /etc/roundcube/config.inc.php, \
                                /usr/bin/chown root\:www-data /etc/roundcube/config.inc.php, \
                                /usr/sbin/a2enconf roundcube, \
                                /usr/sbin/a2disconf roundcube, \
                                /usr/sbin/apache2ctl configtest

# ── Install wizard: clean conflicting OpenDKIM systemd drop-ins (TCP milter needs no socket fixup) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/bin/rm -rf /etc/systemd/system/opendkim.service.d, \
                                /usr/bin/systemctl daemon-reload

# ── Install wizard: postfix config validation (read-only check only) ──

ceymail-mc ALL=(root) NOPASSWD: /usr/sbin/postconf -n
