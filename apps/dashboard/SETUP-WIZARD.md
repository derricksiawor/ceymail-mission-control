# CeyMail First-Run Setup Wizard

Zero-configuration first-run experience for CeyMail Mission Control. Users run `npm run dev` and are guided through database setup, table creation, and admin account creation via a 4-step browser wizard — no manual `.env` editing required.

---

## Quick Start

```bash
cd apps/dashboard
npm install
npm run dev
# Visit http://localhost:3000 -> auto-redirects to /welcome
```

---

## How It Works

### State Machine

```
UNCONFIGURED  ->  No config file, no env vars  ->  Show /welcome wizard
CONFIGURED    ->  Config exists, DB accessible  ->  Check for admin user
NEEDS_ADMIN   ->  DB works, no admin user       ->  Show admin creation step
READY         ->  Everything works              ->  Normal dashboard
```

State is determined by `GET /api/welcome/status` and drives both the wizard UI and the login page redirect logic.

### Config File

Runtime configuration is stored in `data/config.json` (git-ignored, `mode: 0o600`):

```json
{
  "version": 1,
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "ceymail",
    "password": "<auto-generated>",
    "mailDatabase": "ceymail",
    "dashboardDatabase": "ceymail_dashboard"
  },
  "session": {
    "secret": "<64-char hex, crypto.randomBytes(32)>"
  },
  "setupCompletedAt": "2026-02-07T12:00:00.000Z"
}
```

The config module (`src/lib/config/config.ts`) reads this file with in-memory caching and mtime-based invalidation. It falls back to environment variables (`DB_PASSWORD`, `SESSION_SECRET`) for backward compatibility with existing deployments.

**Security:** The root/admin DB password provided during setup is used transiently to create the `ceymail` user and is never stored. Only the `ceymail` user credentials are persisted in the config file.

---

## Wizard Steps

### Step 1 — Welcome

Branding screen with overview of what the wizard will do. Single "Get Started" button.

### Step 2 — Database Setup

Two-phase form:

1. **Test Connection** — User provides MariaDB host, port, and root credentials. Calls `POST /api/welcome/test-db` to verify connectivity. Displays server version on success.

2. **Set Up Database** — Calls `POST /api/welcome/provision` which executes 9 sub-steps:
   - Connect to database server
   - Create `ceymail` database
   - Create `ceymail_dashboard` database
   - Create `ceymail` database user (with auto-generated password)
   - Grant privileges on both databases
   - Create mail tables (`virtual_domains`, `virtual_users`, `virtual_aliases`)
   - Create dashboard tables (`dashboard_users`, `audit_logs`, `install_state`)
   - Save `data/config.json`
   - Reset connection pools and activate session secret

Each sub-step shows real-time progress with checkmarks.

### Step 3 — Admin Account

Username, email, password (with strength meter and complexity checklist), and confirm password. Calls `POST /api/welcome/create-admin` which:
- Validates input (3-50 char username, email format, password complexity)
- Hashes password with SSHA512 + 16-byte random salt
- Inserts into `dashboard_users`
- Sets `setupCompletedAt` in config
- Returns a signed session token (HMAC-SHA256)

### Step 4 — Activate & Auto-Login

After admin creation, the browser navigates to `GET /api/welcome/activate?token=<session-token>`. This endpoint returns an HTML page that:

1. Sets the `mc-session` cookie via `Set-Cookie` header (httpOnly, sameSite=lax)
2. Calls `POST /api/welcome/persist-secret` to write `SESSION_SECRET` to `.env.local`
3. Polls `GET /api/auth/me` until the middleware accepts the session
4. Redirects to the dashboard

The polling is necessary because Next.js Edge Runtime bundles `process.env` at compile time — the middleware needs an HMR recompile to read the new secret. The `persistSessionSecret()` function handles this by touching `src/middleware.ts` to trigger the recompile (dev mode only).

---

## File Map

### New Files

| File | Purpose |
|------|---------|
| `src/lib/config/config.ts` | Read/write/cache `data/config.json`, env var fallback, session secret persistence |
| `src/app/(welcome)/layout.tsx` | Welcome layout — server-side redirect to `/` if setup already done |
| `src/app/(welcome)/welcome/page.tsx` | Welcome page wrapper |
| `src/components/welcome/welcome-wizard.tsx` | 4-step wizard state machine |
| `src/components/welcome/steps/welcome-intro.tsx` | Step 1: branding + "Get Started" |
| `src/components/welcome/steps/database-setup.tsx` | Step 2: DB connection + provisioning |
| `src/components/welcome/steps/admin-account.tsx` | Step 3: admin user creation form |
| `src/components/welcome/steps/setup-complete.tsx` | Step 4: success + auto-redirect |
| `src/app/api/welcome/status/route.ts` | `GET` — returns setup state |
| `src/app/api/welcome/test-db/route.ts` | `POST` — test DB connection with provided creds |
| `src/app/api/welcome/provision/route.ts` | `POST` — create DBs, tables, user, save config |
| `src/app/api/welcome/create-admin/route.ts` | `POST` — create first admin, sign session token |
| `src/app/api/welcome/activate/route.ts` | `GET` — set cookie, return activation HTML page |
| `src/app/api/welcome/persist-secret/route.ts` | `POST` — write `.env.local` + touch middleware |
| `data/.gitkeep` | Ensures `data/` directory exists in repo |

### Modified Files

| File | Changes |
|------|---------|
| `src/lib/db/connection.ts` | Reads credentials from config module; exports `resetPools()` |
| `src/lib/auth/session.ts` | `getSecret()` reads from config first, env vars as fallback |
| `src/middleware.ts` | Welcome routes added to public routes, rate limits, allowed methods; cookie deletion removed from 401 handler |
| `src/app/(auth)/login/page.tsx` | Checks `/api/welcome/status`; redirects to `/welcome` if unconfigured |
| `.gitignore` | `apps/dashboard/data/` excluded (except `.gitkeep`) |

---

## API Reference

All welcome endpoints are **unauthenticated** (public) and **rate-limited**.

### `GET /api/welcome/status`

Returns the current setup state. No request body.

```json
{ "state": "UNCONFIGURED" | "CONFIGURED" | "NEEDS_ADMIN" | "READY" }
```

Rate limit: 30 req/min.

### `POST /api/welcome/test-db`

Tests a database connection with user-provided credentials. Root password is never stored or logged.

```json
// Request
{ "host": "localhost", "port": 3306, "rootUser": "root", "rootPassword": "..." }

// Response (success)
{ "success": true, "version": "10.6.22-MariaDB-0ubuntu0.22.04.1" }

// Response (failure)
{ "success": false, "error": "Access denied for user 'root'@'localhost'" }
```

Rate limit: 10 req/min.

### `POST /api/welcome/provision`

Creates databases, tables, and the `ceymail` user. Saves `data/config.json`. Idempotent (uses `IF NOT EXISTS` throughout).

```json
// Request
{
  "host": "localhost", "port": 3306,
  "rootUser": "root", "rootPassword": "...",
  "ceymailUser": "ceymail", "ceymailPassword": "..."
}

// Response
{
  "success": true,
  "steps": [
    { "step": "connect", "status": "done", "detail": "Connected to localhost:3306" },
    { "step": "create_mail_db", "status": "done", "detail": "Database created or already exists" },
    ...
  ]
}
```

Rate limit: 5 req/min. Refuses to run if setup is already complete.

### `POST /api/welcome/create-admin`

Creates the first admin user and returns a session token.

```json
// Request
{ "username": "admin", "email": "admin@example.com", "password": "..." }

// Response
{
  "sessionToken": "<base64url-payload>.<hmac-sha256-hex>",
  "user": { "id": 1, "username": "admin", "email": "...", "role": "admin" }
}
```

Rate limit: 5 req/min. Refuses to run if an admin already exists.

### `GET /api/welcome/activate?token=<session-token>`

Sets the session cookie and returns an HTML activation page. The page persists the session secret and polls until the middleware is ready, then redirects to `/`.

Rate limit: 10 req/min.

### `POST /api/welcome/persist-secret`

Writes `SESSION_SECRET` from config to `.env.local` and touches the middleware source to trigger an HMR recompile in dev mode.

Rate limit: 5 req/min.

---

## Middleware Changes

The Edge Runtime middleware (`src/middleware.ts`) handles authentication for all API routes. Key behaviors for the wizard:

- **Public routes:** All `/api/welcome/*` endpoints bypass authentication
- **No cookie deletion:** The middleware never deletes the `mc-session` cookie on verification failure. This prevents a race condition during the first-run flow where the middleware may temporarily lack the session secret during HMR env reloads. Stale cookies expire naturally via `maxAge` (7 days); explicit deletion is handled only by the logout endpoint.
- **Secret resolution order:** `process.env.SESSION_SECRET` > `globalThis.__MC_SESSION_SECRET` > `process.env.DB_PASSWORD` > `""` (empty = skip verification, only public routes accessible)

---

## Backward Compatibility

Existing deployments that use environment variables (`DB_PASSWORD`, `SESSION_SECRET`) continue to work without changes. The config module falls back to env vars when no `data/config.json` exists:

```
Config file present?  -->  YES  -->  Use config.json values
                      -->  NO   -->  Use DB_PASSWORD / SESSION_SECRET env vars
```

---

## Dev Mode Considerations

### Edge Runtime Env Var Caching

Next.js Edge Runtime bundles `process.env` values at middleware compile time. Writing `.env.local` triggers an env reload but does **not** recompile the middleware. The `persistSessionSecret()` function works around this by appending a timestamp comment to `src/middleware.ts`, forcing an HMR recompile that picks up the new `SESSION_SECRET`.

This only affects development mode. In production, env vars are set before the build and bundled at `next build` time.

### HMR Reload Timing

After `.env.local` is written, the activate page polls `/api/auth/me` every 500ms (up to 20 attempts / 10 seconds) waiting for the middleware to accept the session cookie. A `<meta http-equiv="refresh">` at 12 seconds acts as a final fallback.

---

## Security

| Concern | Mitigation |
|---------|------------|
| Root DB password | Used transiently during provision, never stored |
| Config file permissions | Written with `mode: 0o600` (owner read/write only) |
| Session secret | 256-bit cryptographically random (`crypto.randomBytes(32)`) |
| Session tokens | HMAC-SHA256 signed, 7-day expiry, httpOnly cookie |
| Password hashing | SSHA512 with 16-byte random salt |
| Rate limiting | All wizard endpoints rate-limited (5-30 req/min per IP) |
| Double-run protection | Provision and create-admin refuse to execute if already completed |
| CORS | Same-origin only; localhost allowed in dev mode |
| Input validation | Username 3-50 chars, email format, password complexity (8+ chars, upper/lower/number/special) |
